<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>구글 로그인 연동 테스트 (code → /user/google)</title>
    <style>
        #profile-box { display: none; border: 1px solid #ddd; padding: 20px; width: 360px; margin-top: 20px; border-radius: 10px; }
        #profile-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .muted { color:#666; font-size:12px; }
        .row { margin: 6px 0; }
        button { margin-right: 8px; padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; background:#fff; cursor:pointer; }
        code { font-size: 12px; }
    </style>
</head>
<body>

<h2>구글 로그인 (Spring Boot 연동)</h2>
<p class="muted">
    ✅ 이 페이지는 <b>authorization code</b>를 받아서 <code>POST /user/google</code>로 <code>{ code }</code>를 보냅니다.<br/>
    ✅ 이후 API 호출은 <code>Authorization: Bearer {accessToken}</code>를 자동으로 붙입니다.
</p>

<!-- Google 로그인 버튼 -->
<div id="google-login-area">
    <button id="googleLoginBtn">Google로 로그인</button>
</div>

<div id="profile-box">
    <h3>로그인 성공!</h3>
    <img id="profile-img" src="" alt="프로필 이미지"><br/>

    <div class="row"><strong>이름:</strong> <span id="user-name"></span></div>
    <div class="row"><strong>이메일:</strong> <span id="user-email"></span></div>
    <div class="row"><strong>userId:</strong> <span id="user-id"></span></div>

    <div class="row muted">
        accessToken(localStorage): <span id="token-preview"></span>
    </div>

    <button onclick="callMe()">/user/me 호출 테스트</button>
    <button onclick="callRunning()">/user/me/running 호출 테스트</button>
    <button onclick="callComplete()">/user/me/complete 호출 테스트</button>
    <button onclick="logout()">로그아웃</button>
</div>

<!-- ✅ Google Identity Services (OAuth2 Code Client) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
    // ==========================
    // ✅ 설정: 본인 Google OAuth Client ID
    // ==========================
    const GOOGLE_CLIENT_ID = "216903189163-a8vbhhhcedp76hs3tj2fndp755rbani4.apps.googleusercontent.com";

    // ==========================
    // ✅ fetch에 Bearer 자동 첨부 (axios.defaults 대체)
    // ==========================
    function authorizedFetch(url, options = {}) {
        const token = localStorage.getItem("accessToken");
        const headers = new Headers(options.headers || {});
        if (token) headers.set("Authorization", `Bearer ${token}`);
        return fetch(url, { ...options, headers });
    }

    // ==========================
    // ✅ (1) code를 백엔드로 보내서 JWT 받기
    //   - 너 컨트롤러: POST /user/google { code }
    //   - 응답: { accessToken, user }
    // ==========================
    async function sendCodeToBackend(code) {
        const res = await fetch("/user/google", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code })
        });

        if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`로그인 실패: ${res.status} ${text}`);
        }

        const data = await res.json();
        console.log("Login successful with server response:", data);

        // ✅ accessToken 처리 (네 JS와 동일)
        if (data.accessToken) {
            const accessToken = data.accessToken;
            localStorage.setItem("accessToken", accessToken);
            console.log("accessToken 저장 완료!");
        } else {
            console.warn("응답에 accessToken이 없습니다:", data);
        }

        // ✅ user 정보 처리 (네 JS와 동일)
        if (data.user) {
            localStorage.setItem("userInfo", JSON.stringify(data.user));
            console.log("userInfo 저장 완료!");

            if (data.user.id !== undefined && data.user.id !== null) {
                localStorage.setItem("memberId", String(data.user.id));
                console.log("memberId 저장 완료!");
            }
        } else {
            console.warn("응답에 user가 없습니다:", data);
        }

        return data;
    }

    // ==========================
    // ✅ (2) UI 렌더링
    // ==========================
    function renderLoginSuccess(data) {
        const user = data.user || {};

        document.getElementById("profile-box").style.display = "block";
        document.getElementById("google-login-area").style.display = "none";

        document.getElementById("user-name").innerText = user.name ?? "";
        document.getElementById("user-email").innerText = user.email ?? "";
        document.getElementById("user-id").innerText = user.id ?? "";

        if (user.profileUrl) {
            document.getElementById("profile-img").src = user.profileUrl;
        } else {
            document.getElementById("profile-img").src = "";
        }

        const token = localStorage.getItem("accessToken") || "";
        document.getElementById("token-preview").innerText =
            token ? (token.length > 30 ? token.slice(0, 30) + "..." : token) : "(없음)";
    }

    // ==========================
    // ✅ (3) Google OAuth2 "Code Client" 초기화
    // ==========================
    let codeClient;

    window.onload = () => {
        // Code flow client
        codeClient = google.accounts.oauth2.initCodeClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: "openid email profile",
            callback: async (resp) => {
                try {
                    // resp.code 가 진짜 authorization code
                    console.log("Google auth code:", resp.code);

                    const data = await sendCodeToBackend(resp.code);
                    renderLoginSuccess(data);
                } catch (e) {
                    console.error("에러 발생:", e);
                    alert("로그인 처리에 실패했습니다.");
                }
            }
        });

        document.getElementById("googleLoginBtn").addEventListener("click", () => {
            // 구글 로그인 팝업 → code 받기
            codeClient.requestCode();
        });

        // 세션 복구
        restoreSession();
    };

    function restoreSession() {
        const token = localStorage.getItem("accessToken");
        const userInfoRaw = localStorage.getItem("userInfo");
        if (token && userInfoRaw) {
            try {
                const user = JSON.parse(userInfoRaw);
                renderLoginSuccess({ user, accessToken: token });
            } catch (_) {}
        }
    }

    // ==========================
    // ✅ 테스트용 API 호출들 (principal 확인용)
    // ==========================
    async function callMe() {
        const res = await authorizedFetch("/user/me", { method: "GET" });
        const text = await res.text();
        alert(`/user/me: ${res.status}\n${text}`);
    }

    async function callRunning() {
        const res = await authorizedFetch("/user/me/running", { method: "GET" });
        const text = await res.text();
        alert(`/user/me/running: ${res.status}\n${text}`);
    }

    async function callComplete() {
        const res = await authorizedFetch("/user/me/complete", { method: "GET" });
        const text = await res.text();
        alert(`/user/me/complete: ${res.status}\n${text}`);
    }

    // ==========================
    // ✅ 로그아웃
    // ==========================
    async function logout() {
        try {
            await authorizedFetch("/user/logout", { method: "POST" });

            localStorage.removeItem("accessToken");
            localStorage.removeItem("userInfo");
            localStorage.removeItem("memberId");

            alert("로그아웃 되었습니다.");
            location.reload();
        } catch (e) {
            console.error(e);
            alert("로그아웃 처리에 실패했습니다.");
        }
    }
</script>

</body>
</html>
